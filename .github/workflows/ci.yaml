name: CI
on:
  workflow_call:
    inputs:
      sha:
        description: 'the git sha to checkout'
        required: true
        type: string
      publish-wheels:
        description: 'whether to publish wheels to the artifact repo'
        default: false
        required: true
        type: boolean
jobs:
  test-components:
    strategy:
      fail-fast: false
      matrix:
        component:
          - oneml-pipelines
          - oneml-processors
          - oneml-habitats
    runs-on: ["self-hosted", "1ES.Pool=oneml.github-runner-pool.dv5"]
    name: "test: ${{ matrix.component }}"
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
          fetch-depth: 0
          fetch-tags: true
      - id: "authenticate"
        name: "authenticate"
        run: |
          # authenticate as the managed identity we assigned to the 1es runner
          az login \
          --identity \
          -u /subscriptions/5cdce458-55d0-479a-9e75-d331b234c8f7/resourcegroups/oneml.ci/providers/Microsoft.ManagedIdentity/userAssignedIdentities/oneml-github-runner-pool
          # auth to acr resources we use
          az acr login --name immunodata
          # generate an access token that we use for the run
          TOKEN=$(az account get-access-token --query accessToken --output tsv --subscription "Immunomics R&D")
          # Prevents the token from being output in logs
          echo "::add-mask::$TOKEN"
          echo "writing access token to $GITHUB_OUTPUT"
          echo access-token=$TOKEN >> $GITHUB_OUTPUT
      - id: "create-build-image"
        name: "create-build-image"
        run: |
          TOKEN="${{ steps.authenticate.outputs.access-token }}"
          # create a secrets file for docker to use
          mkdir -p .tmp
          echo "export POETRY_HTTP_BASIC_IMMUNOMICS_ARTIFACTS_PASSWORD=${TOKEN}" > .tmp/docker-build.env
          # run the docker build by mounting our secrets
          docker build \
            -t immunodata.azurecr.io/oneml/${{ matrix.component }}:local \
            --secret id=build-envs,src=.tmp/docker-build.env \
            -f ${{ matrix.component }}/Dockerfile.build .
      - id: "package-info"
        name: "package-info"
        run: |
          # use poetry to find out the version of our package
          VERSION=$(docker run \
            -w /opt/build/${{ matrix.component }} \
            -v $PWD:/opt/build:ro \
            immunodata.azurecr.io/oneml/${{ matrix.component }}:local \
            poetry version --short)
          PKG_NAME=$(echo "${{ matrix.component }}" | tr '-' '_')
          PKG_NAME=$(echo "${{ matrix.component }}" | tr '-' '_')
          PKG_WHEEL="$PKG_NAME-$VERSION-py3-none-any.whl"
          echo package-version=$VERSION >> $GITHUB_OUTPUT
          echo package-name=$PKG_NAME >> $GITHUB_OUTPUT
          echo package-wheel=$PKG_WHEEL >> $GITHUB_OUTPUT
      - name: ruff
        run: |
          docker run \
            -v $PWD/.tmp:/opt/oneml/.tmp \
            immunodata.azurecr.io/oneml/${{ matrix.component }}:local poetry run ruff check --output-format=github src/python/ test/python/
      - name: pyright
        run: |
          docker run \
            -v $PWD/.tmp:/opt/oneml/.tmp \
            immunodata.azurecr.io/oneml/${{ matrix.component }}:local poetry run pyright
      - name: pytest
        run: |
          docker run \
            -v $PWD/.tmp:/opt/oneml/.tmp \
            immunodata.azurecr.io/oneml/${{ matrix.component }}:local poetry run pytest
      - name: "build-wheels"
        run: |
          mkdir -p wheels
          docker run \
            -e POETRY_DYNAMIC_VERSIONING_BYPASS=${{ steps.package-info.outputs.package-version }} \
            -v $PWD/wheels:/opt/oneml/${{ matrix.component }}/dist \
            immunodata.azurecr.io/oneml/${{ matrix.component }}:local poetry build -f wheel
      - name: publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: .tmp/${{ matrix.component }}/reports/pytest-junit.xml
          check_name: "Test Results: ${{ matrix.component }}"
      - name: "upload-artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: "wheels.${{ matrix.component }}"
          path: "wheels/${{ steps.package-info.outputs.package-wheel }}"
  publish-artifacts:
    if: "${{ inputs.publish-wheels }}"
    needs: test-components
    runs-on: ["self-hosted", "1ES.Pool=oneml.github-runner-pool.dv5"]
    name: "push-artifacts"
    steps:
      - id: "authenticate"
        name: "authenticate"
        run: |
          # authenticate as the managed identity we assigned to the 1es runner
          az login \
          --identity \
          -u /subscriptions/5cdce458-55d0-479a-9e75-d331b234c8f7/resourcegroups/oneml.ci/providers/Microsoft.ManagedIdentity/userAssignedIdentities/oneml-github-runner-pool
          # auth to acr resources we use
          az acr login --name immunodata
          # generate an access token that we use for the run
          TOKEN=$(az account get-access-token --query accessToken --output tsv --subscription "Immunomics R&D")
          # Prevents the token from being output in logs
          echo "::add-mask::$TOKEN"
          echo "writing access token to $GITHUB_OUTPUT"
          echo access-token=$TOKEN >> $GITHUB_OUTPUT
      - name: download-wheels
        uses: actions/download-artifact@v4
        with:
          path: dist/
          pattern: "wheels.*"
          merge-multiple: true
      - name: publish-wheels
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ steps.authenticate.outputs.access-token }}
          repository-url: https://pkgs.dev.azure.com/immunomics/_packaging/immunomics-artifacts/pypi/upload
  build-docs:
    strategy:
      fail-fast: false
      matrix:
        component:
          - oneml-pipelines
          - oneml-processors
          - oneml-habitats
    runs-on: ["self-hosted", "1ES.Pool=oneml.github-runner-pool.dv5"]
    name: "docs: ${{ matrix.component }}"
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
          fetch-depth: 0
          fetch-tags: true
      - id: "authenticate"
        name: "authenticate"
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          # authenticate as the managed identity we assigned to the 1es runner
          az login \
          --identity \
          -u /subscriptions/5cdce458-55d0-479a-9e75-d331b234c8f7/resourcegroups/oneml.ci/providers/Microsoft.ManagedIdentity/userAssignedIdentities/oneml-github-runner-pool
          # auth to acr resources we use
          az acr login --name immunodata
          # generate an access token that we use for the run
          TOKEN=$(az account get-access-token --query accessToken --output tsv --subscription "Immunomics R&D")
          # Prevents the token from being output in logs
          echo "::add-mask::$TOKEN"
          echo "writing access token to $GITHUB_OUTPUT"
          echo access-token=$TOKEN >> $GITHUB_OUTPUT
      - name: "install-devtools"
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          TOKEN="${{ steps.authenticate.outputs.access-token }}"
          pipx install poetry
          poetry config http-basic.immunomics-artifacts "__token__" "$TOKEN"
          pipx install \
            -e -i https://$TOKEN@pkgs.dev.azure.com/immunomics/_packaging/immunomics-artifacts/pypi/simple \
            oneml-devtools/
      - name: "poetry-install"
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          oneml-devtools install ${{ matrix.component }}/
      - name: "build-docs"
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          oneml-devtools build-docs ${{ matrix.component }}/
