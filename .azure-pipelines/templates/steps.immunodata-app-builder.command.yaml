# THIS FILE WAS GENERATED BY IMMUNODATA PLATFORM LIBRARIES.
# EDIT WITH CAUTION!

parameters:
  - name: builderImage
    type: string
  - name: command
    type: string
  - name: subscription
    type: string
    default: "Immunomics R&D (7bd3802d-452e-4b2a-964e-e2c996bc7477)"
  - name: name
    type: string
  - name: retryCountOnTaskFailure
    type: number
    default: 0

steps:
- task: AzureCLI@2
  retryCountOnTaskFailure: ${{ parameters.retryCountOnTaskFailure }}
  inputs:
    azureSubscription: '${{ parameters.subscription }}'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    useGlobalConfig: true
    inlineScript: |
      # Should exist if we've run the authenticate template!
      export DEVOPS_PYPI_URL=$PIP_EXTRA_INDEX_URL
      export POETRY_HTTP_BASIC_IMMUNOMICS_ARTIFACTS_PASSWORD=$(System.AccessToken)
      export PYENV_SHELL=bash

      # Make sure the venv directories exists!
      mkdir -p .tmp/docker.virtualenvs.pipenv
      mkdir -p .tmp/docker.virtualenvs.poetry

      CMD="docker run \
        -e DEVOPS_PYPI_URL \
        -e POETRY_HTTP_BASIC_IMMUNOMICS_ARTIFACTS_PASSWORD \
        -e PYENV_SHELL \
        -e IMMUNODATA_USER_EMAIL=azure-devops@managed-identity \
        -v $PWD:$PWD \
        -v $PWD/.tmp/docker.virtualenvs.pipenv:/root/.local/share/virtualenvs \
        -v $PWD/.tmp/docker.virtualenvs.poetry:/root/.cache/pypoetry/virtualenvs \
        -v $DOCKER_CONFIG:/root/.docker:ro \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v $HOME/.azure:/root/.azure \
        -v $KUBECONFIG:$KUBECONFIG:ro \
        -e KUBECONFIG \
        -v $(PYPIRC_PATH):/root/.pypirc:ro \
        ${{ parameters.builderImage }} \
        ${{ parameters.command }}"

      echo "Running: $CMD"

      exec $CMD
  displayName: 'Builder: ${{ parameters.name }}'
