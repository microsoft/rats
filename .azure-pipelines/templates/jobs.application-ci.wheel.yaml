# THIS FILE WAS GENERATED BY IMMUNODATA PLATFORM LIBRARIES.
# EDIT WITH CAUTION!

parameters:
  - name: appBuilderImageName
    type: string
  - name: appBuilderImageTag
    type: string
  - name: component
    type: string
    values:
    - oneml-app
    - oneml-devtools
    - oneml-pipelines
    - oneml-processors
  - name: isDevBuild
    type: boolean
  - name: publishWheel
    type: boolean
  - name: python_dependency_tool
    type: string
    values:
    - "pipenv"
    - "poetry"

jobs:
- job:
  displayName: "Python Wheel: ${{ parameters.component }}"
  pool:
    vmImage: "ubuntu-latest"

  steps:
  - checkout: self
    submodules: true
  - script: |
      mkdir -p .tmp/artifacts
    displayName: "Artifacts Directory"

  - template: /.azure-pipelines/templates/steps.authenticate.yaml
  - template: /.azure-pipelines/templates/steps.define-build-variables.yaml
    parameters:
      appBuilderImageName: ${{ parameters.appBuilderImageName }}
      appBuilderImageTag: ${{ parameters.appBuilderImageTag }}
      component: ${{ parameters.component }}
      isDevBuild: ${{ parameters.isDevBuild }}

  - ${{ if eq(parameters.python_dependency_tool, 'pipenv') }}:
    - template: /.azure-pipelines/templates/steps.immunodata-app-builder.command.yaml
      parameters:
        builderImage: ${{ parameters.appBuilderImageName }}:${{ parameters.appBuilderImageTag }}
        command: "immunocli-next -vvv ci pipenv-install --component ${{ parameters.component }} --path $PWD"
        name: Pipenv Install
  - ${{ if eq(parameters.python_dependency_tool, 'poetry') }}:
    - template: /.azure-pipelines/templates/steps.immunodata-app-builder.command.yaml
      parameters:
        builderImage: ${{ parameters.appBuilderImageName }}:${{ parameters.appBuilderImageTag }}
        command: "immunocli-next -vvv ci poetry-install --component ${{ parameters.component }} --path $PWD"
        name: Poetry Install
        retryCountOnTaskFailure: 1

  - template: /.azure-pipelines/templates/steps.immunodata-app-builder.command.yaml
    parameters:
      builderImage: ${{ parameters.appBuilderImageName }}:${{ parameters.appBuilderImageTag }}
      command: "immunocli-next -vvv ci build-wheel ${{ parameters.component }} --path $PWD"
      name: Build Wheels

  - ${{ if eq(parameters.publishWheel, true) }}:
    - template: /.azure-pipelines/templates/steps.immunodata-app-builder.command.yaml
      parameters:
        builderImage: ${{ parameters.appBuilderImageName }}:${{ parameters.appBuilderImageTag }}
        command: 'immunocli-next -vvv ci publish-wheels ${{ parameters.component }} --path $PWD'
        name: Publish Wheels

  - ${{ if eq(parameters.python_dependency_tool, 'pipenv') }}:
    - template: /.azure-pipelines/templates/steps.immunodata-app-builder.command.yaml
      parameters:
        builderImage: ${{ parameters.appBuilderImageName }}:${{ parameters.appBuilderImageTag }}
        command: "immunocli-next -vvv ci generate-cg-manifests ${{ parameters.component }} --path $PWD --pipenv"
        name: Generate Component Governance manifests
  - ${{ if eq(parameters.python_dependency_tool, 'poetry') }}:
    - template: /.azure-pipelines/templates/steps.immunodata-app-builder.command.yaml
      parameters:
        builderImage: ${{ parameters.appBuilderImageName }}:${{ parameters.appBuilderImageTag }}
        command: "immunocli-next -vvv ci generate-cg-manifests ${{ parameters.component }} --path $PWD"
        name: Generate Component Governance manifests

  - publish: ".tmp/artifacts"
    artifact: "ci.artifacts.${{ parameters.component }}.wheel"
    displayName: "Publish: .tmp/artifacts"
