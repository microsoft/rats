# THIS FILE WAS GENERATED BY IMMUNODATA PLATFORM LIBRARIES.
# EDIT WITH CAUTION!

parameters:
  - name: appBuilderImageName
    type: string
  - name: appBuilderImageTag
    type: string
  - name: component
    type: string
    values:
    - oneml-devtools
    - oneml-pipelines
    - oneml-processors
  - name: isDevBuild
    type: boolean
  - name: namespace
    type: string
    values:
    - "production"
    - "ci-pr-builds"
  - name: python_dependency_tool
    type: string
    values:
    - "poetry"

jobs:
- job:
  displayName: "Docker: ${{ parameters.component }}"
  pool:
    vmImage: "ubuntu-latest"

  steps:
  - checkout: self
    submodules: true
  - script: |
      mkdir -p .tmp/artifacts
    displayName: "Artifacts Directory"

  - template: /.azure-pipelines/templates/steps.authenticate.yaml
  # Provides $BUILD_BRANCH
  - template: /.azure-pipelines/templates/steps.define-build-variable.build-branch.yaml
  - template: /.azure-pipelines/templates/steps.define-build-variables.yaml
    parameters:
      appBuilderImageName: ${{ parameters.appBuilderImageName }}
      appBuilderImageTag: ${{ parameters.appBuilderImageTag }}
      isDevBuild: ${{ parameters.isDevBuild }}

  - template: /.azure-pipelines/templates/steps.immunodata-app-builder.command.yaml
    parameters:
      # This doesn't execute anything in the app's env so we can use the base builder and save ~2 minutes
      builderImage: ${{ parameters.appBuilderImageName }}:${{ parameters.appBuilderImageTag }}
      command: >-
        immunocli-next
        -vvv ci
        docker-build ${{ parameters.component }}
        --path $PWD
        --image-tag $BUILD_VERSION
        --pull
        --push
        --build-remote
        --publish-dataset
        --registry immunodata.azurecr.io
        --dataset-namespace ${{ parameters.namespace }}
        --dataset-user azure-devops@managed-identity
        --dataset-branch $BUILD_BRANCH
        --dataset-partition $BUILD_VERSION
      name: Build/Push Docker Image

  - script: |
      IMAGE_NAME=${{ parameters.component }}
      IMAGE_TAG="immunodata.azurecr.io/$IMAGE_NAME:$BUILD_VERSION"
      echo "Generating .tmp/artifacts/docker-image"
      echo "$IMAGE_TAG" >> .tmp/artifacts/docker-image
    displayName: "Artifacts: Docker Image"

  - publish: ".tmp/artifacts"
    artifact: "ci.artifacts.${{ parameters.component }}.docker"
    displayName: "Publish: .tmp/artifacts"
